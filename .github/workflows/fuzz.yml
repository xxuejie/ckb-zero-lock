name: Fuzz

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  CARGO_FUZZ_VERSION: 0.12.0
  TARGET_CC: clang
  RUSTFLAGS: "-C debug_assertions"
  FUZZ_TIME: 900

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Install llvm
      run: sudo apt update && sudo apt install -y llvm clang llvm-dev protobuf-compiler
    - name: Install nightly Rust
      run: rustup toolchain install nightly
    - name: Install riscv64 target
      run: rustup target add riscv64imac-unknown-none-elf
    - uses: actions/cache@v4
      with:
        path: ${{ runner.tool_cache }}/cargo-fuzz
        key: cargo-fuzz-bin-${{ env.CARGO_FUZZ_VERSION }}
    - run: echo "${{ runner.tool_cache }}/cargo-fuzz/bin" >> $GITHUB_PATH
    - run: cargo install --root "${{ runner.tool_cache }}/cargo-fuzz" --version ${{ env.CARGO_FUZZ_VERSION }} cargo-fuzz --locked
    - name: Install ckb-vm-syscall-tracer
      run: |
        cargo install \
          --git https://github.com/xxuejie/ckb-script-fuzzing-toolkit \
          --rev 479052e565ef872fbf60531a1ce2dcf54e83085a \
          ckb-vm-syscall-tracer
    - name: Fuzz
      run: |
        cd fuzzers/libfuzzer-protobuf-fuzzer && \
          make fuzz JOBS=`nproc` FUZZ_ARGS="-max_total_time=${{ env.FUZZ_TIME }}"
